<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Learning makes me happy."><title>OS Notes: Multi-threads | Xiaojie (Steven)'s Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">OS Notes: Multi-threads</h1><a id="logo" href="/.">Xiaojie (Steven)'s Blog</a><p class="description">It supposed to be hard. If it isn't hard then everyone will do it. The hard is what makes it great.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">OS Notes: Multi-threads</h1><div class="post-meta">Oct 31, 2017<span> | </span><span class="category"><a href="/categories/Operation-System/">Operation System</a><a href="/categories/Operation-System/Threads/">Threads</a></span></div><div class="post-content"><p>Thread is not like process. It is created for distributing a job. For process, different processes represent different jobs. This is the essential difference between thread and process. In other words, threads under the same process have the same logic (run the same code segment) while processes are not. </p>
<p>Therefore, thread creation in Java is using ‘Job-Worker’ model (encouraged one):</p>
<p>1) Create ‘Runnable’ object and implement ‘run()’ method. This step is to define the job.</p>
<p>2) Create a thread object using the Runnable object in above. (new Thread(new MyRunnable())). This step is to create a worker. </p>
<p>BTW, the details and another thread creation way (implementing ‘run()’ of Thread interface) are illustrated at: <a href="http://blog.csdn.net/firehotest/article/details/52835716" target="_blank" rel="external">http://blog.csdn.net/firehotest/article/details/52835716</a></p>
<p>From the memory perspective, thread does not has its own memory space. Threads under the same process share the memory space of the process. Different processes have different memory spaces. </p>
<p>From the instrinct of sharing memory space, we need to think about the following aspects: </p>
<p>1) What does the memory space contains? What does this means in Java?</p>
<p>2) What is the pros and cons compares to process? (kernal or not)</p>
<p>3) How can we coordinate the threads? (locks, wait &amp; notify, thread.join(), etc)</p>
<p>4) Classic application case: Producer &amp; Consumer. </p>
<h2 id="I-What-does-it-means"><a href="#I-What-does-it-means" class="headerlink" title="I. What does it means?"></a>I. What does it means?</h2><p>A process is represented by a class in Java. In a public class, we can define a static main function which is actually the main thread. </p>
<p>For a memory content of a process, we can see we have following things: </p>
<p>1) Data (static variables)</p>
<p>2) Stack (method temporary variables)</p>
<p>3) Heap (description and instant variables values)</p>
<p>4) Code (cinit, init and others methods byte codes)</p>
<p>Typically, those are what we have for a class in Java. Therefore, for those threads which share the same memory space of a particular process, they shared Data, Heap and Codes. </p>
<p>They share codes therefore they have the same logics. However, they may need to change the values of variables in Data and Heap. In order to achieve and make sure the correctness, we need to perform some kind of ‘protection’ on the data in Heap and Data. </p>
<p>Another thing worth noticing is, although they don’t share the variables of stack (e.g. the iterative variable in for loop), and each thread has its own copy of stack variables, we still need to know there is not any protection for their stack variables. Another thread, if it wants, can modify this thread’s stack variable. Although this is not allowed in Java, but if we use C, we can use trick of ‘stack frame overflow’ to modify the other thread’s stack frame’s content. </p>
<p>For details of how the code section like: <a href="http://blog.csdn.net/firehotest/article/details/52747964" target="_blank" rel="external">http://blog.csdn.net/firehotest/article/details/52747964</a></p>
<h2 id="II-What-is-the-pros-and-cons"><a href="#II-What-is-the-pros-and-cons" class="headerlink" title="II.  What is the pros and cons?"></a>II.  What is the pros and cons?</h2><p>The most positive charactristic of thread is its ‘agile’. Of course, agile can only be used to describe those user level threads. Kernal level threads are similar to processes. I would like to call them ‘heavy machines’. Because the switch operation between them needs an interruption and kernal call. The expense of kernal call is very high; therefore, sometimes if we don’t take such expense into account and use multi-threads blindly, we will achieve a worse efficiency outcome. </p>
<p>Now, you may ask, if the user level thread has the efficient switch benefit, why do we need the kernal level thread? The answer is: the kernal ones can run on different cores in order to achieve real parallelism while the user level ones can only run on the same core and achieve ‘fake’ parallelism using pineline technology. </p>
<p>For the detailed comparison, you can turn to following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">线程实际上分为两类：用户级线程（User Level）和内核级线程 (Kernal Level)。只有内核级线程是真正的分核运行的，</div><div class="line"></div><div class="line">用户级线程操作系统的根本不可见的。对于这类线程，有关线程管理的所有工作都由应用程序完成，内核意识不到线程的存在。在应用程序启动后，操作系统分配给该程序一个进程号，以及其对应的内存空间等资源。应用程序通常先在一个线程中运行，该线程被成为主线“程。在其运行的某个时刻，可以通过调用线程库中的函数创建一个在相同进程中运行的新线程。 用户级线程的好处是非常高效，不需要进入内核空间。</div><div class="line"></div><div class="line">内核级线程的管理工作由内核完成，应用程序没有进行线程管理的代码，只能调用内核线程的接口。内核级线程的好处是，内核可以将不同线程更好地分配到不同的CPU，以实现真正的并行计算。</div></pre></td></tr></table></figure>
<h2 id="III-Coordination-Techniques"><a href="#III-Coordination-Techniques" class="headerlink" title="III. Coordination Techniques"></a>III. Coordination Techniques</h2><p>This part I going to illustrate the command techniques under the context of Java. I am going to talk about following areas:</p>
<h2 id="3-1-Locks-from-different-perspectives"><a href="#3-1-Locks-from-different-perspectives" class="headerlink" title="3.1 Locks from different perspectives. "></a>3.1 Locks from different perspectives. </h2><p>You can refer to this blog to see the details: <a href="http://blog.csdn.net/firehotest/article/details/78431938" target="_blank" rel="external">http://blog.csdn.net/firehotest/article/details/78431938</a></p>
<p>Generally, we can classify the locks into: mutex, semaphore, read/write lock and spinning lock. </p>
<p>Also, we can classify them from following perspectives: 1) Share/Exclusive (read/write), 2) Reentrant Lock, 3) Fair/Unfair Lock, 4) Optimistic/Pessimistic Lock</p>
<p>Regarding to two different ways of Thread creation in Java and explanation for race condition, please turn to  <a href="http://blog.csdn.net/firehotest/article/details/52835716" target="_blank" rel="external">http://blog.csdn.net/firehotest/article/details/52835716</a></p>
<p>Regarding to two different types of synchronized in Java and thread-safe classes discussion please turn to <a href="http://blog.csdn.net/firehotest/article/details/78453891" target="_blank" rel="external">http://blog.csdn.net/firehotest/article/details/78453891</a></p>
<p>Regarding to Java implementation of semaphore, read/write lock and reentrant lock(fair/unfair) usage please turn to: <a href="http://blog.csdn.net/firehotest/article/details/60455811" target="_blank" rel="external">http://blog.csdn.net/firehotest/article/details/60455811</a></p>
<h2 id="3-2-Object-notify-and-Object-wait-让线程交替运行"><a href="#3-2-Object-notify-and-Object-wait-让线程交替运行" class="headerlink" title="3.2 Object.notify() and Object.wait() 让线程交替运行"></a>3.2 Object.notify() and Object.wait() 让线程交替运行</h2><p>Talking about wait and notify methods, we must understand the difference between wait() and sleep(). </p>
<p>Wait() will let the current thread enter a state of waiting for other threads notify it and <b>give up all the locks it has</b>. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Thread.sleep(int ms)和Object.wait()的区别：</div><div class="line"></div><div class="line">对于thread类，有一个类成员方法是sleep(int ms)，让一个线程休眠（阻塞）一段时间，以ms为单位。但其不证明其休眠刚刚好是对应数字的时间，因为当对应的时间结束后，其进入了就绪状态，等待着JVM的调用。</div><div class="line"></div><div class="line">而对应Object.wait()的作用也是让调用它的线程进入休眠。其也可以指定一个时间让它醒过来，也可以不指定，通过别人线程调用notify()或者notifyAll()来唤醒它。但是就算指定一个时间，也能被notify()或者notifyAll()提前唤醒。</div><div class="line"></div><div class="line">那么两个休眠有什么不同呢？</div><div class="line"></div><div class="line">1）前者是没有意义的阻塞，纯粹就是让它安静一会；后者则是大多数为了等待另外一个线程准备好其要资源，再起来继续工作；</div><div class="line">2）所以，来到了最大的不同了：sleep的进程不会释放同步锁，所以，如果一个线程进入了一个同步方法或者一个同步代码块，在块内调用sleep()了，则在它休眠的时间内，其它的线程不会进入对象级别的同步的所有代码块或者方法。但是，调用wait()则不同了，线程会释放掉同步锁，让其它进程能进入其它的或者当前的对象级别的代码块或者方法内部继续执行。</div></pre></td></tr></table></figure>
<p>Then, we need to understand that notify and wait must be used with synchronized in order to work well. Here is the example: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * A 1, B 1, B 2, B 3, A 2, A 3</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">demo3</span><span class="params">()</span> </span>&#123;</div><div class="line">    Object lock = <span class="keyword">new</span> Object();</div><div class="line">    Thread A = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">                System.out.println(<span class="string">"A 1"</span>);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    lock.wait();</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                System.out.println(<span class="string">"A 2"</span>);</div><div class="line">                System.out.println(<span class="string">"A 3"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    Thread B = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">                System.out.println(<span class="string">"B 1"</span>);</div><div class="line">                System.out.println(<span class="string">"B 2"</span>);</div><div class="line">                System.out.println(<span class="string">"B 3"</span>);</div><div class="line">                lock.notify();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    A.start();</div><div class="line">    B.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Result is as followed:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">A 1</div><div class="line">A waiting…</div><div class="line"> </div><div class="line">B 1</div><div class="line">B 2</div><div class="line">B 3</div><div class="line">A 2</div><div class="line">A 3</div></pre></td></tr></table></figure>
<h2 id="3-3-Thead-join-让一个线程等另外一个线程结束才运行"><a href="#3-3-Thead-join-让一个线程等另外一个线程结束才运行" class="headerlink" title="3.3 Thead.join() 让一个线程等另外一个线程结束才运行"></a>3.3 Thead.join() 让一个线程等另外一个线程结束才运行</h2><p>Join can easily schedule two threads running priority. However, its constraint is we must let one thread finish first then only with the first thread completion, should the other thread begins. Also, it can be useful only if you have exactly two threads. </p>
<p>Here is the example: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">demo2</span><span class="params">()</span> </span>&#123;</div><div class="line">    Thread A = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            printNumber(<span class="string">"A"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    Thread B = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"B 开始等待 A"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                A.join();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            printNumber(<span class="string">"B"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    B.start();</div><div class="line">    A.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Result is as followed: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">B 开始等待 A</div><div class="line">A print: 1</div><div class="line">A print: 2</div><div class="line">A print: 3</div><div class="line"> </div><div class="line">B print: 1</div><div class="line">B print: 2</div><div class="line">B print: 3</div></pre></td></tr></table></figure>
<h2 id="3-4-CountdownLatch-让线程D在A、B、C都同步运行完之后，才能运行"><a href="#3-4-CountdownLatch-让线程D在A、B、C都同步运行完之后，才能运行" class="headerlink" title="3.4 CountdownLatch() 让线程D在A、B、C都同步运行完之后，才能运行"></a>3.4 CountdownLatch() 让线程D在A、B、C都同步运行完之后，才能运行</h2><p>Latch in chinese is ‘门栓’. Therefore, ‘CountdownLatch()’ is setting a latch which is on when the counter does not equal to 0. As soon as the counter becomes zero, the thread with CountdownLatch.await() in its run method will start working. </p>
<p>Don’t forget, the other threads should use CoungdownLatch.countdown() to decrement the counter. </p>
<p>Please notice that await() and countdown() are instant methods. </p>
<p>Here is an example: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runDAfterABC</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> worker = <span class="number">3</span>;</div><div class="line">    CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(worker);</div><div class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"D is waiting for other three threads"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                countDownLatch.await();</div><div class="line">                System.out.println(<span class="string">"All done, D starts working"</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;).start();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> threadName=<span class="string">'A'</span>; threadName &lt;= <span class="string">'C'</span>; threadName++) &#123;</div><div class="line">        <span class="keyword">final</span> String tN = String.valueOf(threadName);</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                System.out.println(tN + <span class="string">"is working"</span>);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">100</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                System.out.println(tN + <span class="string">"finished"</span>);</div><div class="line">                countDownLatch.countDown();</div><div class="line">            &#125;</div><div class="line">        &#125;).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The result is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">D is waiting for other three threads</div><div class="line">A is working</div><div class="line">B is working</div><div class="line">C is working</div><div class="line"> </div><div class="line">A finished</div><div class="line">C finished</div><div class="line">B finished</div><div class="line">All done, D starts working</div></pre></td></tr></table></figure>
<h2 id="3-5-CyclicBarrier类-让多个线程同时做准备工作，等全部线程都就绪后再一起开始"><a href="#3-5-CyclicBarrier类-让多个线程同时做准备工作，等全部线程都就绪后再一起开始" class="headerlink" title="3.5 CyclicBarrier类 让多个线程同时做准备工作，等全部线程都就绪后再一起开始"></a>3.5 CyclicBarrier类 让多个线程同时做准备工作，等全部线程都就绪后再一起开始</h2><p>CyclicBarrier makes every target threads do their ready phase independently. However, they must wait until each other finishes ready phase before they start their working phase. </p>
<p>先创建一个公共 CyclicBarrier 对象，设置 同时等待 的线程数，CyclicBarrier cyclicBarrier = new CyclicBarrier(3);<br>这些线程同时开始自己做准备，自身准备完毕后，需要等待别人准备完毕，这时调用 cyclicBarrier.await(); 即可开始等待别人；<br>当指定的 同时等待的线程数都调用了 cyclicBarrier.await();时，意味着这些线程都准备完毕好，然后这些线程才同时继续执行。</p>
<p>Here is the example: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runABCWhenAllReady</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> runner = <span class="number">3</span>;</div><div class="line">    CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(runner);</div><div class="line">    <span class="keyword">final</span> Random random = <span class="keyword">new</span> Random();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> runnerName=<span class="string">'A'</span>; runnerName &lt;= <span class="string">'C'</span>; runnerName++) &#123;</div><div class="line">        <span class="keyword">final</span> String rN = String.valueOf(runnerName);</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">long</span> prepareTime = random.nextInt(<span class="number">10000</span>) + <span class="number">100</span>;</div><div class="line">                System.out.println(rN + <span class="string">"is preparing for time:"</span> + prepareTime);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(prepareTime);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    System.out.println(rN + <span class="string">"is prepared, waiting for others"</span>);</div><div class="line">                    cyclicBarrier.await(); <span class="comment">// 当前运动员准备完毕，等待别人准备好</span></div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                System.out.println(rN + <span class="string">"starts running"</span>); <span class="comment">// 所有运动员都准备好了，一起开始跑</span></div><div class="line">            &#125;</div><div class="line">        &#125;).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Here is the result: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">A is preparing for time: 4131</div><div class="line">B is preparing for time: 6349</div><div class="line">C is preparing for time: 8206</div><div class="line"> </div><div class="line">A is prepared, waiting for others</div><div class="line"> </div><div class="line">B is prepared, waiting for others</div><div class="line"> </div><div class="line">C is prepared, waiting for others</div><div class="line"> </div><div class="line">C starts running</div><div class="line">A starts running</div><div class="line">B starts running</div></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/Thread/">Thread</a><a href="/tags/Locks/">Locks</a></div><div class="post-nav"><a href="/2017/11/20/D-S-Notes-Summary/" class="pre">D.S. Notes: Summary</a><a href="/2017/10/30/Exception-Notes-How-to-use-Exception-wisely-in-Java/" class="next">Exception Notes: How to use Exception wisely in Java</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://stevenlicmu.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Operation-System/">Operation System</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Operation-System/Threads/">Threads</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Poems/">Poems</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Technique/">Technique</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Techniques/">Techniques</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Locks/" style="font-size: 15px;">Locks</a> <a href="/tags/Technique/" style="font-size: 15px;">Technique</a> <a href="/tags/Frontends/" style="font-size: 15px;">Frontends</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Thread/" style="font-size: 15px;">Thread</a> <a href="/tags/Exception/" style="font-size: 15px;">Exception</a> <a href="/tags/Maven/" style="font-size: 15px;">Maven</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/Shakespeare/" style="font-size: 15px;">Shakespeare</a> <a href="/tags/Talmud/" style="font-size: 15px;">Talmud</a> <a href="/tags/WebApplication/" style="font-size: 15px;">WebApplication</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/07/04/Web-Application-Design-Foundation/">Web-Application-Design-Foundation</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/20/D-S-Notes-Summary/">D.S. Notes: Summary</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/31/OS-Notes-Multi-threads/">OS Notes: Multi-threads</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/Exception-Notes-How-to-use-Exception-wisely-in-Java/">Exception Notes: How to use Exception wisely in Java</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/23/Frontend-Notes-Playground/">Frontend Notes: Playground</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/23/Maven-Notes-Basic-Operations/">Maven Notes: Basic Operations</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/17/Git-Notes-Some-useful-Tips-for-Git/">Git Notes: Some useful Tips for Git</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/15/Talmud-Extract/">Talmud Extract</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/15/Shakespeare-Poems-Extracts/">Shakespeare Poems Extracts</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/21/SQL-Notes-Single-row-functions/">SQL Notes: Single row functions</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://blog.csdn.net/firehotest" title="Old Blog" target="_blank">Old Blog</a><ul></ul><a href="http://github.com/stevenlicmu" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="http://www.linkedin.com/in/stevenlicmu/" title="LinkedIn" target="_blank">LinkedIn</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Xiaojie (Steven)'s Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>